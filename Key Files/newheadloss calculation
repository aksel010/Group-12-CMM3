import numpy as np
from scipy.optimize import fsolve
import sympy as sp
from pathlib import Path
from heptane_itpl import (
        calculate_h, 
        Cp_func, 
        rho_func, 
        mu_func,
        lambda_func # lambda_func (thermal conductivity) is also needed by calculate_h
    )

import numpy as np
from scipy.optimize import fsolve

class SystemParams:
    def __init__(self):
        # Geometry parameters from the paper
        self.n = 5  # number of branches
        self.D = 17e-03  # main pipe diameter (m)
        self.w_branch = 30e-03  # branch width (m)
        self.h_branch = 2.75e-03  # branch height (m)
        self.L_a = 0.5  # main pipe length per segment (m)
        self.L_b = 0.5  # branch length (m)
        self.g = 9.81  # gravitational acceleration (m/s²)
        
        # Calculate areas
        self.S_a = np.pi * (self.D/2)**2  # main pipe cross-sectional area
        self.S_b = self.w_branch * self.h_branch  # branch cross-sectional area
        self.d_H = 2 * self.w_branch * self.h_branch / (self.w_branch + self.h_branch)  # hydraulic diameter

def calculate_head_loss_A(Q, params, ν):
    """
    Calculate head loss for Group Set A according to Equation 30
    
    Q: array of flow rates in each branch [Q1, Q2, Q3, Q4, Q5]
    params: SystemParams object
    ν: kinematic viscosity (m²/s)
    """
    n = len(Q)
    H = np.zeros(n)
    
    for i in range(n):  # for each branch i (0-indexed, but represents branch i+1)
        # Friction loss in main pipes (first term in Eq 30)
        main_pipe_loss = 0
        for j in range(i + 1):  # sum from j=1 to i (in paper notation)
            sum_Q_m = np.sum(Q[j:])  # ∑Qₘ from m=j to n
            term = (32 * ν * params.L_a / (params.D**2 * params.g)) * (sum_Q_m / params.S_a)
            main_pipe_loss += term
        
        main_pipe_loss *= 2  # the 2× factor in Eq 30
        
        # Friction loss in branch pipe (second term in Eq 30)
        branch_pipe_loss = (32 * ν * params.L_b / 
                           (params.d_H**2 * params.g)) * (Q[i] / params.S_b)
        
        H[i] = main_pipe_loss + branch_pipe_loss
    
    return H

def solve_flow_distribution(Q_total, params, T_avg_K):
    """
    Solve for individual branch flows Qi given total flow Q_total
    
    Returns: array of flows [Q1, Q2, Q3, Q4, Q5] that satisfy H1 = H2 = ... = H5
    """
    # Calculate fluid properties
    μ = mu_func(T_avg_K)  # dynamic viscosity
    ρ = rho_func(T_avg_K)  # density
    ν = μ / ρ  # kinematic viscosity
    
    def equations(Q_individual):
        """
        Equations to solve: All head losses should be equal
        and sum of individual flows should equal total flow
        """
        Q = Q_individual[:-1]  # Q1 through Q5
        H_ref = Q_individual[-1]  # reference head loss
        
        # Calculate head losses for each branch
        H = calculate_head_loss_A(Q, params, ν)
        
        # Equations: H_i - H_ref = 0 for all i, and sum(Q) - Q_total = 0
        eqs = []
        for i in range(params.n):
            eqs.append(H[i] - H_ref)
        eqs.append(np.sum(Q) - Q_total)
        
        return eqs
    
    # Initial guess: equal flow distribution
    Q_initial_guess = np.ones(params.n + 1)  # [Q1, Q2, Q3, Q4, Q5, H_ref]
    Q_initial_guess[:-1] = Q_total / params.n  # equal flow distribution
    Q_initial_guess[-1] = 1.0  # initial guess for head loss
    
    # Solve the system of equations
    solution = fsolve(equations, Q_initial_guess)
    
    Q_individual = solution[:-1]  # extract Q1 through Q5
    H_final = solution[-1]  # final head loss
    
    return Q_individual, H_final

# Example usage:
if __name__ == "__main__":
    params = SystemParams()
    Q_total = 5.0 / 60000  # Convert 5 L/min to m³/s
    T_avg = 300  # Average temperature in K
    
    Q_individual, H_loss = solve_flow_distribution(Q_total, params, T_avg)
    
    print("Flow distribution solution:")
    for i, Q in enumerate(Q_individual, 1):
        print(f"Q{i} = {Q*60000:.2f} L/min")  # Convert back to L/min for readability
    print(f"Head loss H = {H_loss:.4f} m")
    print(f"Total flow verification: {np.sum(Q_individual)*60000:.2f} L/min")
    
    # Calculate bias rate β (Equation 2 in paper)
    β = (np.max(Q_individual) - np.min(Q_individual)) / np.min(Q_individual)
    print(f"Bias rate β = {β*100:.2f}%")